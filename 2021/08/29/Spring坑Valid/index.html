<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="lanicc"><title>Spring的坑——Valid | lanicc</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring的坑——Valid</h1><a id="logo" href="/.">lanicc</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Spring的坑——Valid</h1><div class="post-meta">2021-08-29<span> | </span><span class="category"><a href="/categories/%E8%B8%A9%E5%9D%91%E5%A4%A7%E4%BA%8B%E8%AE%B0/">踩坑大事记</a><a href="/categories/%E8%B8%A9%E5%9D%91%E5%A4%A7%E4%BA%8B%E8%AE%B0/Spring/">Spring</a></span></div><div class="post-content"><p>由于Spring提供的方法级的参数校验<code>MethodValidationInterceptor</code>无法对参数属性进行校验，于是想要自己实现参数校验逻辑，自定义了一个注解<code>@Validated</code>(和Spring的注解<code>@Validated</code>重名)，可是却因此发现了一个Spring的坑…</p>
<span id="more"></span>

<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>本人负责在公司的基础组件部，需要开发一些通用的组件提供给其他业务部门使用，开发组件的过程中，发现很多地方都需要用到参数校验，本来是想使用Spring提供的，但是发现不满足需求，于是乎踩了这个坑</p>
<h2 id="先定一下说法"><a href="#先定一下说法" class="headerlink" title="先定一下说法"></a>先定一下说法</h2><p>引用<a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/validator/6.2/reference/en-US/html_single/#chapter-method-constraints">hibernate</a>中的一句话</p>
<blockquote><p>As of Bean Validation 1.1, constraints can not only be applied to JavaBeans and their properties, but also to the parameters and return values of the methods and constructors of any Java type. That way Jakarta Bean Validation constraints can be used to specify</p>
</blockquote>


<ul>
<li>参数校验：本文中指方法入参、返回值校验</li>
<li>参数属性校验：本文中指对方法入参的属性校验</li>
</ul>
<h2 id="看一下Spring方法级参数校验的实现"><a href="#看一下Spring方法级参数校验的实现" class="headerlink" title="看一下Spring方法级参数校验的实现"></a>看一下Spring方法级参数校验的实现</h2><h3 id="使用BeanPostProcessor提供方法校验的拦截器"><a href="#使用BeanPostProcessor提供方法校验的拦截器" class="headerlink" title="使用BeanPostProcessor提供方法校验的拦截器"></a>使用BeanPostProcessor提供方法校验的拦截器</h3><p>核心类：<br><code>org.springframework.validation.beanvalidation.MethodValidationPostProcessor</code></p>
<p>该类实现了<code>InitializingBean</code>，在<code>afterPropertiesSet</code>方法中会根据注解<code>@Validated</code>匹配需要拦截的Bean，创建拦截器<code>MethodValidationInterceptor</code>，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> Class&lt;? extends Annotation&gt; validatedAnnotationType = Validated.class;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Pointcut pointcut = <span class="keyword">new</span> AnnotationMatchingPointcut(<span class="keyword">this</span>.validatedAnnotationType, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">this</span>.advisor = <span class="keyword">new</span> DefaultPointcutAdvisor(pointcut, createMethodValidationAdvice(<span class="keyword">this</span>.validator));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Advice <span class="title">createMethodValidationAdvice</span><span class="params">(<span class="meta">@Nullable</span> Validator validator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (validator != <span class="keyword">null</span> ? <span class="keyword">new</span> MethodValidationInterceptor(validator) : <span class="keyword">new</span> MethodValidationInterceptor());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用MethodValidationInterceptor触发校验"><a href="#使用MethodValidationInterceptor触发校验" class="headerlink" title="使用MethodValidationInterceptor触发校验"></a>使用MethodValidationInterceptor触发校验</h3><p>核心类：<br><code>org.springframework.validation.beanvalidation.MethodValidationInterceptor</code></p>
<p><code>MethodValidationInterceptor</code>是<code>org.aopalliance.intercept.MethodInterceptor</code>的一个实现，看一下核心实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">// Avoid Validator invocation on FactoryBean.getObjectType/isSingleton</span></span><br><span class="line">    <span class="keyword">if</span> (isFactoryBeanMetadataMethod(invocation.getMethod())) &#123;</span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] groups = determineValidationGroups(invocation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Standard Bean Validation 1.1 API</span></span><br><span class="line">    ExecutableValidator execVal = <span class="keyword">this</span>.validator.forExecutables();</span><br><span class="line">    Method methodToValidate = invocation.getMethod();</span><br><span class="line">    Set&lt;ConstraintViolation&lt;Object&gt;&gt; result;</span><br><span class="line"></span><br><span class="line">    Object target = invocation.getThis();</span><br><span class="line">    Assert.state(target != <span class="keyword">null</span>, <span class="string">&quot;Target must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = execVal.validateParameters(target, methodToValidate, invocation.getArguments(), groups);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="comment">// Probably a generic type mismatch between interface and impl as reported in SPR-12237 / HV-1011</span></span><br><span class="line">        <span class="comment">// Let&#x27;s try to find the bridged method on the implementation class...</span></span><br><span class="line">        methodToValidate = BridgeMethodResolver.findBridgedMethod(</span><br><span class="line">                ClassUtils.getMostSpecificMethod(invocation.getMethod(), target.getClass()));</span><br><span class="line">        result = execVal.validateParameters(target, methodToValidate, invocation.getArguments(), groups);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object returnValue = invocation.proceed();</span><br><span class="line"></span><br><span class="line">    result = execVal.validateReturnValue(target, methodToValidate, returnValue, groups);</span><br><span class="line">    <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> returnValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第20行，校验方法参数</li>
<li>第35行，校验返回值</li>
</ul>
<p>没有校验参数属性<br>无法满足我的需求，怎么办，造轮子啊</p>
<h2 id="自己实现"><a href="#自己实现" class="headerlink" title="自己实现"></a>自己实现</h2><h3 id="定义注解"><a href="#定义注解" class="headerlink" title="定义注解"></a>定义注解</h3><h4 id="类注解-Validated"><a href="#类注解-Validated" class="headerlink" title="类注解-Validated"></a>类注解-Validated</h4><p>该注解用来标识需要参数校验的类，和Spring的注解<code>org.springframework.validation.annotation.Validated</code>重名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD, ElementType.PARAMETER&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Validated &#123;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] value() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    Class&lt;? extends ConstraintViolationHandler&gt; handler() <span class="keyword">default</span> DefaultConstraintViolationHandler.class;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="参数注解-Valid"><a href="#参数注解-Valid" class="headerlink" title="参数注解-Valid"></a>参数注解-Valid</h4><p>该注解用来标识需要进行校验属性的参数，和<code>javax.validation.Valid</code>重名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.PARAMETER&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Valid &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BeanPostProcessor实现"><a href="#BeanPostProcessor实现" class="headerlink" title="BeanPostProcessor实现"></a>BeanPostProcessor实现</h3><p>和<code>org.springframework.validation.beanvalidation.MethodValidationPostProcessor</code>类似，只是把<code>validatedAnnotationType</code>换成了自己定义的<code>Validated</code>注解</p>
<h3 id="MethodValidationInterceptor实现"><a href="#MethodValidationInterceptor实现" class="headerlink" title="MethodValidationInterceptor实现"></a>MethodValidationInterceptor实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isFactoryBeanMetadataMethod(invocation.getMethod())) &#123;</span><br><span class="line">        <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object target = invocation.getThis();</span><br><span class="line">    Assert.state(target != <span class="keyword">null</span>, <span class="string">&quot;Target must not be null&quot;</span>);</span><br><span class="line">    Method methodToValidate = findBridgedMethod(target, invocation.getMethod());</span><br><span class="line"></span><br><span class="line">    SoValidated soValidated = determineValidatedAnnotation(target, methodToValidate);</span><br><span class="line">    Class&lt;?&gt;[] groups = soValidated.value();</span><br><span class="line">    Class&lt;? extends ConstraintViolationHandler&gt; handler = soValidated.handler();</span><br><span class="line">    ConstraintViolationHandler violationHandler = handler.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Standard Bean Validation 1.1 API</span></span><br><span class="line">    ExecutableValidator execVal = <span class="keyword">this</span>.validator.forExecutables();</span><br><span class="line">    Set&lt;ConstraintViolation&lt;Object&gt;&gt; result;</span><br><span class="line"></span><br><span class="line">    Object[] arguments = invocation.getArguments();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//validateParameters</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = execVal.validateParameters(target, methodToValidate, arguments, groups);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException | ConstraintDeclarationException ex) &#123;</span><br><span class="line">        <span class="comment">// Probably a generic type mismatch between interface and impl as reported in SPR-12237 / HV-1011</span></span><br><span class="line">        <span class="comment">// Let&#x27;s try to find the bridged method on the implementation class...</span></span><br><span class="line">        methodToValidate = BridgeMethodResolver.findBridgedMethod(</span><br><span class="line">                ClassUtils.getMostSpecificMethod(invocation.getMethod(), target.getClass()));</span><br><span class="line"></span><br><span class="line">        soValidated = determineValidatedAnnotation(target, methodToValidate);</span><br><span class="line">        groups = soValidated.value();</span><br><span class="line">        handler = soValidated.handler();</span><br><span class="line">        violationHandler = handler.newInstance();</span><br><span class="line"></span><br><span class="line">        result = execVal.validateParameters(target, methodToValidate, arguments, groups);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">        violationHandler.handle(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Parameter object</span></span><br><span class="line">    Parameter[] parameters = methodToValidate.getParameters();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameters.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (parameters[i].isAnnotationPresent(Valid.class)) &#123;</span><br><span class="line">            result = validator.validate(arguments[i], groups);</span><br><span class="line">            <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">                violationHandler.handle(result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Object returnValue = invocation.proceed();</span><br><span class="line"></span><br><span class="line">    result = execVal.validateReturnValue(target, methodToValidate, returnValue, groups);</span><br><span class="line">    <span class="keyword">if</span> (!result.isEmpty()) &#123;</span><br><span class="line">        violationHandler.handle(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> returnValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>第25行，对参数校验</li>
<li>第47行，对参数属性校验</li>
<li>第56行，对返回值校验</li>
</ul>
<p>和Spring提供的基本一致，只是加了一个对参数属性的校验</p>
<p>完事，写了个测试，跑了一下，结果很完美</p>
<p>然后就发包了</p>
<p>一切似乎都很完美</p>
<h2 id="一不小心地上一个坑"><a href="#一不小心地上一个坑" class="headerlink" title="一不小心地上一个坑"></a>一不小心地上一个坑</h2><p>当我把发的包用在了SpringMVC环境。。。</p>
<p>其实我这个包本来是用在接口上的(service接口)，并不提供controller入口，但是为了让测试同学测试方便，于是我又写了个将service接口暴露为http接口的实现，然后就踩坑了。。</p>
<p>坑就是，校验走的不是我自己写的校验，而是跑到了SpringMVC的校验中</p>
<h3 id="发生在RequestResponseBodyMethodProcessor"><a href="#发生在RequestResponseBodyMethodProcessor" class="headerlink" title="发生在RequestResponseBodyMethodProcessor"></a>发生在RequestResponseBodyMethodProcessor</h3><p>看一下这个类的说明</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Resolves method <span class="built_in">arguments</span> annotated <span class="keyword">with</span> @RequestBody <span class="keyword">and</span> handles <span class="keyword">return</span> values <span class="keyword">from</span> methods annotated <span class="keyword">with</span> @ResponseBody <span class="keyword">by</span> reading <span class="keyword">and</span> writing <span class="keyword">to</span> the body <span class="keyword">of</span> the request <span class="keyword">or</span> response <span class="keyword">with</span> an HttpMessageConverter.</span><br><span class="line">An @RequestBody method argument <span class="keyword">is</span> also validated <span class="keyword">if</span> <span class="literal">it</span> <span class="keyword">is</span> annotated <span class="keyword">with</span> @javax.validation.Valid. In <span class="keyword">case</span> <span class="keyword">of</span> validation failure, MethodArgumentNotValidException <span class="keyword">is</span> raised <span class="keyword">and</span> results <span class="keyword">in</span> an HTTP <span class="number">400</span> response status code <span class="keyword">if</span> DefaultHandlerExceptionResolver <span class="keyword">is</span> configured.</span><br></pre></td></tr></table></figure>

<p>大致意思就是说，这个类是用来处理加了<code>@RequestBody</code>注解的参数和返回值，如果参数带有<code>@javax.validation.Valid</code>注解，还会对参数进行校验</p>
<p>从这个说明来看，没有任何问题，和我写的实现并不冲突，可是！！！实际上不是这样的阿姨</p>
<p>看一下实现</p>
<h4 id="参数处理"><a href="#参数处理" class="headerlink" title="参数处理"></a>参数处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">resolveArgument</span><span class="params">(MethodParameter parameter, <span class="meta">@Nullable</span> ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="params"><span class="function">        NativeWebRequest webRequest, <span class="meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    parameter = parameter.nestedIfOptional();</span><br><span class="line">    Object arg = readWithMessageConverters(webRequest, parameter, parameter.getNestedGenericParameterType());</span><br><span class="line">    String name = Conventions.getVariableNameForParameter(parameter);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (binderFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">        WebDataBinder binder = binderFactory.createBinder(webRequest, arg, name);</span><br><span class="line">        <span class="keyword">if</span> (arg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            validateIfApplicable(binder, parameter);</span><br><span class="line">            <span class="keyword">if</span> (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> MethodArgumentNotValidException(parameter, binder.getBindingResult());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mavContainer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> adaptArgumentIfNecessary(arg, parameter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>第13行，会对参数进行校验</li>
</ul>
<h4 id="参数校验"><a href="#参数校验" class="headerlink" title="参数校验"></a>参数校验</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">validateIfApplicable</span><span class="params">(WebDataBinder binder, MethodParameter parameter)</span> </span>&#123;</span><br><span class="line">    Annotation[] annotations = parameter.getParameterAnnotations();</span><br><span class="line">    <span class="keyword">for</span> (Annotation ann : annotations) &#123;</span><br><span class="line">        Object[] validationHints = ValidationAnnotationUtils.determineValidationHints(ann);</span><br><span class="line">        <span class="keyword">if</span> (validationHints != <span class="keyword">null</span>) &#123;</span><br><span class="line">            binder.validate(validationHints);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>第4行，根据注解获取校验的hints(我翻译不好这个词。。)</li>
</ul>
<p>这里看上去也没有任何问题，继续往下</p>
<h4 id="根据注解获取校验的hints"><a href="#根据注解获取校验的hints" class="headerlink" title="根据注解获取校验的hints"></a>根据注解获取校验的hints</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Determine any validation hints by the given annotation.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;This implementation checks for &#123;<span class="doctag">@code</span> <span class="doctag">@javax</span>.validation.Valid&#125;,</span></span><br><span class="line"><span class="comment"> * Spring&#x27;s &#123;<span class="doctag">@link</span> org.springframework.validation.annotation.Validated&#125;,</span></span><br><span class="line"><span class="comment"> * and custom annotations whose name starts with &quot;Valid&quot;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ann the annotation (potentially a validation annotation)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the validation hints to apply (possibly an empty array),</span></span><br><span class="line"><span class="comment"> * or &#123;<span class="doctag">@code</span> null&#125; if this annotation does not trigger any validation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object[] determineValidationHints(Annotation ann) &#123;</span><br><span class="line">    Class&lt;? extends Annotation&gt; annotationType = ann.annotationType();</span><br><span class="line">    String annotationName = annotationType.getName();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;javax.validation.Valid&quot;</span>.equals(annotationName)) &#123;</span><br><span class="line">        <span class="keyword">return</span> EMPTY_OBJECT_ARRAY;</span><br><span class="line">    &#125;</span><br><span class="line">    Validated validatedAnn = AnnotationUtils.getAnnotation(ann, Validated.class);</span><br><span class="line">    <span class="keyword">if</span> (validatedAnn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Object hints = validatedAnn.value();</span><br><span class="line">        <span class="keyword">return</span> convertValidationHints(hints);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (annotationType.getSimpleName().startsWith(<span class="string">&quot;Valid&quot;</span>)) &#123;</span><br><span class="line">        Object hints = AnnotationUtils.getValue(ann);</span><br><span class="line">        <span class="keyword">return</span> convertValidationHints(hints);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题来了呀</p>
<ul>
<li>第23行，竟然用了个<code>startsWith</code>！！！</li>
</ul>
<p>这个方法上虽然注明了这点<code>custom annotations whose name starts with &quot;Valid&quot;</code>，但是很坑呀，于是我提了个<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/issues/27050">issue</a></p>
<h2 id="issue-AbstractMessageConverterMethodArgumentResolver-validateIfApplicable-do-more-than-expected"><a href="#issue-AbstractMessageConverterMethodArgumentResolver-validateIfApplicable-do-more-than-expected" class="headerlink" title="issue - AbstractMessageConverterMethodArgumentResolver#validateIfApplicable do more than expected"></a>issue - AbstractMessageConverterMethodArgumentResolver#validateIfApplicable do more than expected</h2><p>意思是，<code>AbstractMessageConverterMethodArgumentResolver#validateIfApplicable</code>做的太多</p>
<p>这个<a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-framework/issues/27050">issue</a>提了之后，还有个哥哥以为是我不会自定义校验参数的注解…然后给我评论让我google</p>
<p>不过后来官方的人给了回复</p>
<p>说这个已经存在很久了，会在<code>5.3.9</code>版本的文档中添加说明</p>
<p>在<a target="_blank" rel="noopener" href="https://github.com/liquibase/liquibase-hibernate/pull/341">5.3.9的发行纪要</a>中确实看到了这点</p>
<p><img src="/images/spring_bump539.png" alt="spring_bump539.png"></p>
<h2 id="我认为"><a href="#我认为" class="headerlink" title="我认为"></a>我认为</h2><p>我还是觉得Spring在这里做的有点多，使用<code>startsWith</code>让我觉得很奇葩，坏味道</p>
<p>Spring改不了，只能是我改，后来我把自己定义的注解，都加了个前缀<code>SO</code>，哈哈哈</p>
</div><div class="tags"><a href="/tags/Spring/"><i class="fa fa-tag"></i>Spring</a><a href="/tags/valid/"><i class="fa fa-tag"></i>valid</a></div><div class="post-nav"><a class="next" href="/2021/08/28/test/">test</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=1.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=1.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=1.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '24ccd128ebc34676a0dd',
  clientSecret: '118594e6b386af78bd03e5dac6c5588b93aa1acf',
  repo: 'lanicc.github.io',
  owner: 'lanicc',
  admin: ['lanicc'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://lanicc.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B8%A9%E5%9D%91%E5%A4%A7%E4%BA%8B%E8%AE%B0/">踩坑大事记</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B8%A9%E5%9D%91%E5%A4%A7%E4%BA%8B%E8%AE%B0/Spring/">Spring</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/valid/" style="font-size: 15px;">valid</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/08/29/Spring%E5%9D%91Valid/">Spring的坑——Valid</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/08/28/test/">test</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/lanicc" title="lanicc's github" target="_blank">lanicc's github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">lanicc.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>